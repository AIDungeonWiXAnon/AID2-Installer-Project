<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension"
     xmlns:bal="http://schemas.microsoft.com/wix/BalExtension">

  <!--
  WiX-based EXE bootstrap Installer for AI Dungeon 2: Clover Edition (using Pytorch)
  Developed by: Friendly /vp/oreon
  Last clone from GitHub: c74ba69
  Installs the Clover Edition of AI Dungeon 2 into a given directory and autoinstalls all prerequisites, including Anaconda (Python 3.7) and related packages on Windows 7+ systems.
  Additionally includes support for GPU/CPU-based CUDA installations, accountless cuDNN install, automatic torrent download, and optional color in terminals.
  -->
  
  <?define BuildNumber = 0.0.0.0?> <!-- Beta version to remain as 0.0.0.0 unless otherwise directed -->
  <?define UpgradeGUID = {62718F90-28CF-4B4C-B0A0-7B3598AD4456}?>
  
  <Bundle Name="!(loc.AppName_$(var.Platform))"
          Version="$(var.BuildNumber)"
          Manufacturer="!(loc.Developer)"
          UpgradeCode="$(var.UpgradeGUID)"
          IconSourceFile="$(var.AID2 Clover Edition Installer Beta.ProjectDir)SourceFiles\icon.ico"
          Compressed="yes">

    <BootstrapperApplicationRef Id="WixStandardBootstrapperApplication.RtfLicense">
      <bal:WixStandardBootstrapperApplication
        LicenseFile="$(var.ProjectDir)Assets\README.rtf"
        SuppressOptionsUI="yes"
        LogoFile="$(var.ProjectDir)Assets\icon.png" />
    </BootstrapperApplicationRef>
    
    <!-- NT version 6.1 is at least Windows 7/Windows Server 2008 R2 -->
    <bal:Condition Message="!(loc.ArchitectureMessage)">
      <![CDATA[VersionNT >= v6.1]]>
    </bal:Condition>
    
    <bal:Condition Message="!(loc.AdminMessage)">
      Privileged
    </bal:Condition>

    <!-- TODO: Make the serach some sort of wildcard, since Anaconda includes the version number in the key name -->
    <?if $(var.Platform)=x64 ?>
    <util:RegistrySearch
          Id="CheckForAnacondaInstallation64"
          Variable="AnacondaFoundx64"
          Result="exists"
          Win64="yes"
          Root="HKLM"
          Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Anaconda3 2019.10 (Python 3.7.4 64-bit)"/>
    <?else?>
    <util:RegistrySearch
      Id="CheckForAnacondaInstallation86"
      Variable="AnacondaFoundx86"
      Result="exists"
      Win64="no"
      Root="HKLM"
      Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\Anaconda3 2019.10 (Python 3.7.4 64-bit)"/>
    <?endif?>
    
    
		<Chain>
      
      <!-- TODO: Get Git LFS working so these can be included for compile purposes -->
      <?if $(var.Platform)=x64 ?>
      <ExePackage Id="Anaconda3" SourceFile="$(var.ProjectDir)Assets\Anaconda3-2019.10-Windows-x86_64.exe" Compressed="yes" PerMachine="yes" InstallCondition="NOT AnacondaFoundx64" />
      <?else?>
      <ExePackage Id="Anaconda3" SourceFile="$(var.ProjectDir)Assets\Anaconda3-2019.10-Windows-x86.exe" Compressed="yes" PerMachine="yes" InstallCondition="NOT AnacondaFoundx86" />
      <?endif?>

      <RollbackBoundary Id="PostAnaconda3" />

      <?if $(var.Platform)=x64 ?>
      <MsiPackage Id="AID2CloverEdition" SourceFile="$(var.ProjectDir)Assets\AID2-Clover-Edition-Installer-Beta-x86_64.msi" Compressed="yes" Vital="yes" DisplayInternalUI="yes" />
      <?else?>
      <MsiPackage Id="AID2CloverEdition" SourceFile="$(var.ProjectDir)Assets\AID2-Clover-Edition-Installer-Beta-x86.msi" Compressed="yes" Vital="yes" DisplayInternalUI="yes" />
      <?endif?>  
		</Chain>
	</Bundle>
</Wix>
